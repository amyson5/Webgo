<!DOCTYPE HTML>
<html>

	<head>
		<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Web Go</title>
		<!--script type="text/javascript" src="wgo/wgo.min.js"></script>
		<script type="text/javascript" src="wgo/wgo.player.min.js"></script-->

		<script type="text/javascript" src="wgo/wgo.js"></script>
		<script type="text/javascript" src="wgo/kifu.js"></script>
		<script type="text/javascript" src="wgo/sgfparser.js"></script>
		<script type="text/javascript" src="wgo/player.js"></script>
		<script type="text/javascript" src="wgo/basicplayer.js"></script>
		<script type="text/javascript" src="wgo/basicplayer.component.js"></script>
		<script type="text/javascript" src="wgo/basicplayer.infobox.js"></script>
		<script type="text/javascript" src="wgo/basicplayer.commentbox.js"></script>
		<script type="text/javascript" src="wgo/basicplayer.control.js"></script>
		<script type="text/javascript" src="wgo/player.editable.js"></script>
		<script type="text/javascript" src="wgo/scoremode.js"></script>
		<script type="text/javascript" src="wgo/player.permalink.js"></script>
        <script type="text/javascript" src="wgo/player.playmode.js"></script>

		<script type="text/javascript" src="wgo/i18n.zh.js"></script>
		<script src="wgo/jquery-1.8.3.min.js" type="text/javascript"></script>
		<link type="text/css" href="wgo/wgo.player.css" rel="stylesheet" />
	</head>

	<body>
		<div id="player"></div>
		<section id="busy" style="display: none;"></section>
		<style type="text/css">
		#busy {
		    display: none;
		    position: fixed;
		    left: 0;
		    right: 0;
		    top: 0;
		    bottom: 0;
		    cursor: wait;
		    z-index: 999;
		}
		</style>
		<section id="info-overlay" class="">Please wait…</section>
		<style type="text/css">
		#info-overlay {
	        position: absolute;
	        top: 33%;
	        left: 50%;
	        padding: .5em 3em;
	        border-radius: 1.5em;
	        background: rgba(0, 0, 0, .6);
	        color: white;
	        font-size: 1.5em;
	        white-space: nowrap;
	        transform: translate(-50%, -50%);
	        opacity: 0;
	        transition: opacity .5s;
	        pointer-events: none;
	        z-index: 999;
	    }
		#info-overlay.show {
		    opacity: 1;
		    transition: opacity .1s;
		}
	    </style>
		<script type="text/javascript">
            // get sgf name from URL 127.0.0.1/wgo/xx.html?sgf=lz-545ca-12800_vs_zen7-s1000.sgf
            function getQueryString() {  
                var qs = location.search.substr(1), // 获取url中"?"符后的字串  
                args = {}, // 保存参数数据的对象
                items = qs.length ? qs.split("&") : [], // 取得每一个参数项,
                item = null,
                len = items.length;

              for(var i = 0; i < len; i++) {
                item = items[i].split("=");
                var name = decodeURIComponent(item[0]),
                  value = decodeURIComponent(item[1]);
                if(name) {
                  args[name] = value;
                }
              }
              return args;
            }
            var qs = getQueryString(); 
            var q1 = qs["sgf"];
            var q2 = qs["move"];
            if (q1 === undefined) { q1="1-135.final.sgf"}
            if (q2 === undefined) { q2="85"}
            q1="sgf/"+q1;
            console.log("URL-sgf: ",q1)
            console.log("URL-move: ",q2)

			var elem = document.getElementById("player");
			var player = new WGo.BasicPlayer(elem, {
                //sgf: "(;CA[utf-8]FF[4]SZ[19]GM[1]DT[2017-10-22]PB[Human]BR[10]PW[Zen7]WR[9]KM[7.5]",
                //sgfFile: "sgf/1-135.final.sgf",
                //sgfFile: "sgf/2-135.sgf",
				//sgfFile: "sgf/zen7-s2000_vs_lz-d7f6-30400_3_W+.sgf",
				//sgfFile: "sgf/Zen6-s1.5w_vs_lz-714a-1.08w_B_20180130.sgf",
                //sgfFile: "sgf/lz-d7f6-16000_vs_zen7-s1000_No151.sgf",
                //sgfFile: "sgf/lz-545ca-12800_vs_zen7-s1000.sgf",
                //sgfFile: "sgf/超级大龙不会提.sgf",
                //sgfFile: "sgf/lz-d7f6a-v16000_vs_zen7-s30000_no266.sgf",move: 268,//leelazero左下死活应对错误，被zen7翻盘
                //sgfFile: "sgf/lz-d996f-v16000_vs_zen7-s30000-0_No191.sgf",move: 190,//zen7胜率18%，lz没应对(H13)被zen7翻盘
                //sgfFile: "sgf/lz-b7768-v16000_vs_zen7-s30000-1.sgf",move: 175,//zen7下面突然走了一步打将，185手放活lz白大龙，有点莫名其妙
                sgfFile: q1, move: parseInt(q2),
				board: {
					size: 19,
					width: 0,
					height: 0,
					font: "Calibri",
					lineWidth: 1,
					stoneHandler: WGo.Board.drawHandlers.SHELL,
					starSize: 10,
					stoneSize: 1,
					shadowSize: 1,
					background: "board/02.png",
					//background: "#000000"
					//background: "#FFFFFF"
				},
				//move: 83,//2-135.sgf
				layout: {
					top: ['InfoBox'],
					bottom: ['Control', 'CommentBox']
				},
			});

			var svr_status=0;//0: idle 1:busy
			player.board.addEventListener("click", function(x, y) {
				console.log("click",x,y,player.kifuReader.game.turn)
				if (x<0 || y<0 || x>18 || y>18 || !player.kifuReader.game.isValid(x,y)) {
					//document.getElementsByClassName("wgo-comments-content")[0].innerText="invalid click: "+x+","+y+"("+player.kifuReader.game.turn+")"
					return;
				}
				//document.getElementsByClassName("wgo-comments-content")[0].innerText="click: "+x+","+y+"("+player.kifuReader.game.turn+")"
                
                playmode = document.getElementsByClassName("wgo-menu-item wgo-menu-item-playmode")
                if ( (playmode.length == 0) || (playmode[0].classList.length!=3) ){ // no wgo-selected
                    console.log("normal mode")
                    //document.getElementsByClassName("wgo-comments-content")[0].innerText="nomal mode, can't play"
                    return;
                }

				if (svr_status==1) {
					//document.getElementsByClassName("wgo-comments-content")[0].innerText+="\nsvr is busy"
				} else {
					document.getElementById("busy").style.diaplay="block"
					document.getElementById("info-overlay").style.opacity=1
					//document.getElementsByClassName("wgo-comments-content")[0].innerText+="\nsvr is thinking..."
					//player.board.addObject({x: x, y: y, c: WGo.B})
					svr_status=1;
					var xhr = $.ajax({
						url: 'http://211.160.178.29:20521/go/play_genmove_play',
						timeout : 50000, //超时时间设置，单位毫秒
						type: "POST",
						data: {
							x: x, y: y, color: WGo.B//player.kifuReader.game.turn
						},
						success: function(data) {
							console.log("success: " + JSON.stringify(data));
                            d=JSON.parse(data)
                            document.getElementsByClassName("wgo-comments-content")[0].innerText="GTP cnt rate seq"
                            for(i = 0; i < d.length; i++) {
                                document.getElementsByClassName("wgo-comments-content")[0].innerText+="\n"+"ABCDEFGHJKLMNOPQRST"[d[i].x] + (19-d[i].y) + " " + d[i].count + " " + d[i].winrate + "% " + d[i].seq
                            }
							document.getElementById("busy").style.diaplay="none"
							document.getElementById("info-overlay").style.opacity=0
                            player.kifuReader.node.appendChild(new WGo.KNode({
                                move: {	x: d[0].x, 	y: d[0].y, c: d[0].color},
                                _edited: true})
                            );
                            player.next(player.kifuReader.node.children.length-1);
							svr_status=0;
						},
						error: function(er,statusText,b) {
							//超时，statusText==timeout
							console.log("error: " + JSON.stringify(er));
							document.getElementsByClassName("wgo-comments-content")[0].innerText=JSON.stringify(er);
							document.getElementById("busy").style.diaplay="none"
							document.getElementById("info-overlay").style.opacity=0
							svr_status=0;
						},
						complete : function(XMLHttpRequest,status){
							// 无论success还是error，complete函数都会执行
							if(status=='timeout'){//超时,status还有success,error等值的情况
								xhr.abort();
								//ajaxTimeoutTest.abort();
								console.log("timeout: ");
							}
						}
					});
				}
			});
			
            first_bn=player.components.Control.widgets[2].element.childNodes[0]
            multiprev_bn=player.components.Control.widgets[2].element.childNodes[1]
            prev_bn=player.components.Control.widgets[2].element.childNodes[2]
            next_bn=player.components.Control.widgets[2].element.childNodes[4]
            multinext_bn=player.components.Control.widgets[2].element.childNodes[5]
            last_bn=player.components.Control.widgets[2].element.childNodes[6]
            var prev_fn_count=0;
            prev_fn=function(){
                console.log("previous button pressed ", prev_fn_count);
                //document.getElementsByClassName("wgo-comments-content")[0].innerText="previous button pressed "+prev_fn_count;
                prev_fn_count+=1;
            }
            prev_fn_touch=function(){
                console.log("previous button touched ", prev_fn_count);
                //document.getElementsByClassName("wgo-comments-content")[0].innerText="previous button touched "+prev_fn_count;
                prev_fn_count+=1;
                
                playmode = document.getElementsByClassName("wgo-menu-item wgo-menu-item-playmode")
                if ( (playmode.length == 0) || (playmode[0].classList.length!=3) ){ // no wgo-selected
                    console.log("normal mode")
                    //document.getElementsByClassName("wgo-comments-content")[0].innerText="nomal mode, can't undo"
                    return;
                }
                
                var xhr = $.ajax({
					url: 'http://211.160.178.29:20521/go/undo',
					type: "GET",
					data: {
						step: 1
					},
					success: function(data) {
						console.log("success: " + JSON.stringify(data));
					},
					error: function(er,statusText,b) {
						//超时，statusText==timeout
						console.log("error: " + JSON.stringify(er));
					},
				});

            }
            prev_bn.addEventListener("click",prev_fn);
            prev_bn.addEventListener("touchstart",prev_fn_touch);
            //prev_bn.addEventListener("touchend",prev_fn);

            /*p=document.getElementById("player")
            b=document.createElement("button")
            bfn=function(){console.log("bfn");alert("bfn");}
            b.addEventListener("click",bfn);
            b.className="wgo-button";
            b.title="test";
            p.appendChild(b)*/
            
			$(document).ready(function() {
				console.log("document onload")
                //document.getElementsByClassName("wgo-box-title")[2].style.left="-40px"

                document.getElementsByClassName("wgo-comments-wrapper")[0].style.height="150px"
                
                document.getElementsByClassName("wgo-player-info-title")[0].style.fontSize="10px"
                document.getElementsByClassName("wgo-player-info-title")[1].style.fontSize="10px"
                document.getElementsByClassName("wgo-player-info-title")[2].style.fontSize="10px"
                document.getElementsByClassName("wgo-player-info-title")[3].style.fontSize="10px"
                document.getElementsByClassName("wgo-player-info-title")[4].style.fontSize="10px"
                document.getElementsByClassName("wgo-player-info-title")[5].style.fontSize="10px"
				
				var xhr = $.ajax({
					url: 'http://211.160.178.29:20521/go/clear_board',
					type: "GET",
					data: {
						size: 19, komi: 7.5, rule: "chinese"
					},
					success: function(data) {
						console.log("success: " + JSON.stringify(data));
					},
					error: function(er,statusText,b) {
						//超时，statusText==timeout
						console.log("error: " + JSON.stringify(er));
					},
				});
				
			});
		</script>
	</body>

</html>